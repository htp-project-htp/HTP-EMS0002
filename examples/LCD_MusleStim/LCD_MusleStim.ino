/*
  ******************************************************
  โ๏ธ ุชุญุฐูุฑ ูุงู โ ุฌูุงุฒ ุชุญููุฒ ุงูุนุถูุงุช โ๏ธ
  ******************************************************
  
  ูุฐุง ุงูููุฏ ูุชุญูู ูู ูุญุฏุฉ ุชุญููุฒ ุนุถูู.
  
  โ ุงูุงุณุชุฎุฏุงู ุงููุทููู ููุฌูุงุฒ ุนูู ุนุถูุงุช ุงูุฌุณู ูุฏ ูุณุจุจ ุฅุฌูุงุฏูุง ุนุถูููุง ุฃู ุชููุฌูุง ุฌูุฏููุง.
  โ ูุง ูููุตู ุจุงุณุชุฎุฏุงู ุชุฑุฏุฏุงุช ุฃุนูู ูู 50 ูุฑุชุฒ ุฃู ุฒูุงุฏุฉ ุงูุทุงูุฉ ุงูููุฑุจุงุฆูุฉ ุฏูู ุงุณุชุดุงุฑุฉ ูุฎุชุต.
  โ ููููุน ุงูุงุณุชุฎุฏุงู ุนูู ููุงุทู ุญุณุงุณุฉ ูู ุงูุฌุณู (ูุซู ุงูุฑุฃุณ ุฃู ุงูููุจ).
  โ ูุง ุชุณุชุฎุฏู ุงูุฌูุงุฒ ุฅู ููุช ุชุนุงูู ูู ุฃูุฑุงุถ ูู ุงูููุจ ุฃู ูุฏูู ุฌูุงุฒ ููุธู ุถุฑุจุงุช.
  โ ุชุฃูุฏ ุฏุงุฆููุง ูู ุฅููุงู ุงูุชุดุบูู ูุจู ุชูุตูู ุฃู ูุตู ุงูุฌูุงุฒ ูู ุงูุนุถูุงุช.

  ๐ ูุฐุง ุงูููุฏ ูุงูุฌูุงุฒ ูุฃุบุฑุงุถ ุชุนููููุฉ ูุชุฌุฑูุจูุฉ ููุทุ ูููุณ ูุฎุตุตูุง ููุงุณุชุฎุฏุงู ุงูุทุจู ุฃู ุงูุนูุงุฌู ุฏูู ุฅุดุฑุงู ุทุจู.


  ******************************************************
*/


/*
  ๐ ุญุฏูุฏ ุงูุชุดุบูู ุงูุขูู ููุญุฏุฉ ุชุญููุฒ ุงูุนุถูุงุช:

  โธ ุงูุชุฑุฏุฏ (Frequency):
    - ุงููุฏู: ูู 0 ุฅูู 50 ูุฑุชุฒ (Hz)
    - โ๏ธ ููุตู ุจุนุฏู ุชุฌุงูุฒ 50 ูุฑุชุฒ ูุชุฌูุจ ุงูุฅุฌูุงุฏ ุงูุนุตุจู ุฃู ุงูุนุถูู.

  โธ ููุฉ ุงููุจุถุฉ (Duty Cycle):
    - ุงููุทุงู: ูู 0% ุฅูู 100%
    - โ๏ธ ูููุถู ุนุฏู ุชุฌุงูุฒ 70% ููุชุฑุงุช ุทูููุฉ ูุชูุงุฏู ุงูุชุญููุฒ ุงูุฒุงุฆุฏ.

  โธ ุชูููุช ุงูุชุดุบูู (ON Time):
    - ุงููุฏู: ูู 100 ุฅูู 2000 ูููู ุซุงููุฉ
    - โฑ๏ธ ุฃูุตู ูุฏุฉ ุชุดุบูู ูุณุชูุฑุฉ: 2 ุซุงููุฉ

  โธ ุชูููุช ุงูุฅุทูุงุก (OFF Time):
    - ุงููุฏู: ูู 0 ุฅูู 5000 ูููู ุซุงููุฉ )
    - โฑ๏ธ ุฃูุตู ูุฏุฉ ุฅููุงู: 5 ุซูุงูู

  โ ูุฐู ุงูููู ุชู ุชุญุฏูุฏูุง ูุถูุงู ุงูุณูุงูุฉ ุฃุซูุงุก ุงูุงุณุชุฎุฏุงู.
*/


/*
 ุฑุจุท ุงูุฌูุงุฒ ูุน ุงููุชุญูู 
 Vcc - 5V
 GND - GND 
 PWM - PIN 3

 ุฑุจุท ุงูุดุงุดุฉ ูุน ูุชุฌูู 
 Vcc - 5V
 GND - GND 
 SDA - A4
 SCL - A5
 
 */

#include <Wire.h>                      // ููุชุจุฉ ููุชุนุงูู ูุน ุจุฑูุชูููู I2C (ุถุฑูุฑูุฉ ูุนูู ุดุงุดุฉ LCD I2C)
#include <LiquidCrystal_I2C.h>        // ููุชุจุฉ ููุชุญูู ูู ุดุงุดุฉ LCD ุนุจุฑ I2C
#include <MuscleStim.h>               // ููุชุจุฉ ุฎุงุตุฉ ุจุฌูุงุฒ ุงูุชุญููุฒ ุงูุนุถูู ุงูููุฑุจุงุฆู

#define STIM_PIN 3                    // ุชุนุฑูู ุฑูู ูููุฐ ุงูุฅุฎุฑุงุฌ ุงููุณุชุฎุฏู ููุชุญููุฒ ุงูููุฑุจุงุฆู
#define FREQ_BUTTON_PIN 4             // ุชุนุฑูู ุฑูู ุงููููุฐ ุงูููุตู ุจุฒุฑ ุชุนุฏูู ุงูุชุฑุฏุฏ
#define DUTY_BUTTON_PIN 5             // ุชุนุฑูู ุฑูู ุงููููุฐ ุงูููุตู ุจุฒุฑ ุชุนุฏูู ุงูุดุฏุฉ (duty cycle)

LiquidCrystal_I2C lcd(0x27, 16, 2);   // ุฅูุดุงุก ูุงุฆู ููุดุงุดุฉ LCD ุจุงุณุชุฎุฏุงู ุงูุนููุงู 0x27 ูุนุฏุฏ ุงูุฃุญุฑู 16x2
MuscleStim stim(STIM_PIN);           // ุฅูุดุงุก ูุงุฆู ูุฌูุงุฒ ุงูุชุญููุฒ ูุชุญุฏูุฏ ูููุฐ ุงูุชุญููุฒ

int frequency = 10;                   // ุงูุชุฑุฏุฏ ุงูุงุจุชุฏุงุฆู ููุชุญููุฒ ุงูููุฑุจุงุฆู (ุจุงููุฑุชุฒ)
int dutyCycle = 10;                  // ุดุฏุฉ ุงููุจุถ ุงูุงุจุชุฏุงุฆูุฉ (ูุณุจุฉ ูุฆููุฉ)

unsigned long lastDebounceTime = 0;   // ูุชุบูุฑ ูุชุฎุฒูู ุขุฎุฑ ููุช ุชู ููู ุงูุถุบุท ุนูู ุงูุฒุฑ
const unsigned long debounceDelay = 200; // ูุฏุฉ ููุงููุฉ ุงูุงูุชุฒุงุฒ ููุฒุฑ ูููุน ุงูุชูุฑุงุฑ ุงูุนุดูุงุฆู (200 ูููู ุซุงููุฉ)

void setup() {
    pinMode(FREQ_BUTTON_PIN, INPUT_PULLUP);  // ุชุนููู ุฒุฑ ุงูุชุฑุฏุฏ ูุฅุฏุฎุงู ูุน ููุงููุฉ ุณุญุจ ุฏุงุฎููุฉ
    pinMode(DUTY_BUTTON_PIN, INPUT_PULLUP);  // ุชุนููู ุฒุฑ ุงูุดุฏุฉ ูุฅุฏุฎุงู ูุน ููุงููุฉ ุณุญุจ ุฏุงุฎููุฉ

    lcd.begin();                  // ุจุฏุก ุชุดุบูู ุงูุดุงุดุฉ LCD
    lcd.backlight();              // ุชุดุบูู ุงูุฅุถุงุกุฉ ุงูุฎูููุฉ ููุดุงุดุฉ

    stim.begin();                // ุจุฏุก ุชููุฆุฉ ุฌูุงุฒ ุงูุชุญููุฒ ุงูุนุถูู
    stim.setFrequency(frequency); // ุชุนููู ุงูุชุฑุฏุฏ ุงูุงุจุชุฏุงุฆู ููุชุญููุฒ
    stim.setDutyCycle(dutyCycle); // ุชุนููู ุดุฏุฉ ุงููุจุถ (ูุณุจุฉ ูุฆููุฉ)
    stim.setOnOffTimers(1500, 1000); // ุชุนููู ูุฏุฉ ุงูุชุดุบูู 1500 ูููู ุซุงููุฉุ ูุงูุฅููุงู 1000 ูููู ุซุงููุฉ
    stim.start();                 // ุจุฏุก ุชุดุบูู ุงูุชุญููุฒ

    lcd.setCursor(0, 0);          // ุชุญุฑูู ุงููุคุดุฑ ุฅูู ุฃูู ุณุทุฑ ูู ุงูุดุงุดุฉ
    lcd.print("Freq: ");          // ุทุจุงุนุฉ "Freq: " ุนูู ุงูุดุงุดุฉ
    lcd.print(frequency);         // ุทุจุงุนุฉ ูููุฉ ุงูุชุฑุฏุฏ ุงูุญุงูู
    lcd.print(" Hz");             // ุทุจุงุนุฉ "Hz" ุจุฌุงูุจ ุงูุชุฑุฏุฏ

    lcd.setCursor(0, 1);          // ุงูุงูุชูุงู ุฅูู ุงูุณุทุฑ ุงูุซุงูู ูู ุงูุดุงุดุฉ
    lcd.print("Duty: ");          // ุทุจุงุนุฉ "Duty: " ุนูู ุงูุดุงุดุฉ
    lcd.print(dutyCycle);         // ุทุจุงุนุฉ ูููุฉ ุงูุดุฏุฉ ุงูุญุงููุฉ
    lcd.print(" %");              // ุทุจุงุนุฉ ุนูุงูุฉ ุงููุณุจุฉ ุงููุฆููุฉ
}

void loop() {
    stim.update();  // ุชุญุฏูุซ ุญุงูุฉ ุฌูุงุฒ ุงูุชุญููุฒ (ูุฌุจ ุงุณุชุฏุนุงุคูุง ุจุงุณุชูุฑุงุฑ ูุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ)

    // ุงูุชุญูู ูู ุญุงูุฉ ุฒุฑ ุงูุชุฑุฏุฏ ูุชุญุฏูุซ ุงููููุฉ ุนูุฏ ุงูุถุบุท
    if (digitalRead(FREQ_BUTTON_PIN) == LOW && (millis() - lastDebounceTime > debounceDelay)) {
        frequency += 10;              // ุฒูุงุฏุฉ ุงูุชุฑุฏุฏ ุจููุฏุงุฑ 10 ูุฑุชุฒ
        if (frequency > 50) frequency = 10;  // ุฅุนุงุฏุฉ ุงูุชุฑุฏุฏ ุฅูู 10 ุฅุฐุง ุชุฌุงูุฒ 50
        stim.setFrequency(frequency);       // ุชุญุฏูุซ ุงูุชุฑุฏุฏ ูู ุฌูุงุฒ ุงูุชุญููุฒ
        updateLCD();                        // ุชุญุฏูุซ ุงููุนูููุงุช ุงููุนุฑูุถุฉ ุนูู ุงูุดุงุดุฉ
        lastDebounceTime = millis();        // ุชุญุฏูุซ ููุช ุขุฎุฑ ุถุบุท ููุฒุฑ
    }

    // ุงูุชุญูู ูู ุญุงูุฉ ุฒุฑ ุงูุดุฏุฉ ูุชุญุฏูุซ ุงููููุฉ ุนูุฏ ุงูุถุบุท
    if (digitalRead(DUTY_BUTTON_PIN) == LOW && (millis() - lastDebounceTime > debounceDelay)) {
        dutyCycle += 10;              // ุฒูุงุฏุฉ ุงูุดุฏุฉ ุจููุฏุงุฑ 10%
        if (dutyCycle > 100) dutyCycle = 10; // ุฅุนุงุฏุฉ ุงูุดุฏุฉ ุฅูู 10% ุฅุฐุง ุชุฌุงูุฒุช 100%
        stim.setDutyCycle(dutyCycle);       // ุชุญุฏูุซ ุงูุดุฏุฉ ูู ุฌูุงุฒ ุงูุชุญููุฒ
        updateLCD();                        // ุชุญุฏูุซ ุงููุนูููุงุช ุงููุนุฑูุถุฉ ุนูู ุงูุดุงุดุฉ
        lastDebounceTime = millis();        // ุชุญุฏูุซ ููุช ุขุฎุฑ ุถุบุท ููุฒุฑ
    }
}

void updateLCD() {
    lcd.clear();                   // ูุณุญ ูุญุชููุงุช ุงูุดุงุดุฉ ุจุงููุงูู
    lcd.setCursor(0, 0);           // ุชุญุฑูู ุงููุคุดุฑ ุฅูู ุฃูู ุณุทุฑ
    lcd.print("Freq: ");           // ุทุจุงุนุฉ "Freq: "
    lcd.print(frequency);          // ุทุจุงุนุฉ ูููุฉ ุงูุชุฑุฏุฏ
    lcd.print(" Hz");              // ุทุจุงุนุฉ "Hz"

    lcd.setCursor(0, 1);           // ุชุญุฑูู ุงููุคุดุฑ ุฅูู ุงูุณุทุฑ ุงูุซุงูู
    lcd.print("Duty: ");           // ุทุจุงุนุฉ "Duty: "
    lcd.print(dutyCycle);          // ุทุจุงุนุฉ ูููุฉ ุงูุดุฏุฉ
    lcd.print(" %");               // ุทุจุงุนุฉ "%"
}
